---
title: "Geospatial Analysis with R"
subtitle: Class 16
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["default", "lucy", "middlebury-fonts", "themes/class18.css"]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---


## Today

- HW from last class
- Your questions
- Intro to raster

---

### Review HW Exercises 
- division into steps
- code

---

## plot figures Example 1
```{r, echo=FALSE, fig.align = "center", fig.height = 4, fig.width = 6}
par(mar=c(0,0,0,0)) ## margins 
plot(pressure)
```


---

## plot figures Example 2
```{r, echo=FALSE, fig.align = "right", fig.height = 2, fig.width = 2}
par(mar=c(3,3,3,3)) ## margins 
plot(pressure)
```



---
### Data

```{r,  message =FALSE}
library(geospaar)
farmers <- system.file("extdata/farmer_spatial.csv", package = "geospaar") %>% 
  read_csv() %>% st_as_sf(coords = c("x", "y"))
districts <- st_read(system.file("extdata/districts.shp", package = "geospaar"))
roads <- read_sf(system.file("extdata/roads.shp", package = "geospaar"))

set.seed(2)
districts2 <- cbind(districts, st_centroid(districts) %>% st_coordinates()) %>% 
  mutate(yield = (7 - 0.25 * -Y) * runif(n = nrow(.), min = 0.9, max = 1.2)) %>%
  mutate(yld_cat = ifelse(yield > 4.5, "high", "other"), 
         yld_cat = ifelse(between(yield, 3.5, 4.5), "medium", yld_cat),
         yld_cat = ifelse(yield < 3.5, "low", yld_cat)) %>% 
  dplyr::select(distName, X, Y, yield, yld_cat)
farmer_ct <- farmers %>% group_by(uuid) %>% count() %>% 
  st_set_crs(st_crs(districts))
farmers_districts <- st_join(farmer_ct, districts2, largest = TRUE)
farmers_per_dist <- farmers_districts %>% group_by(distName) %>% count()
districts3 <- as_tibble(farmers_per_dist) %>% dplyr::select(distName, n) %>% 
  left_join(districts2, .) %>% mutate(n = ifelse(is.na(n), 0, n))
```



---
## raster introduction
- R packages `raster` and `terra`. we will use `raster`
- [`terra`](https://search.r-project.org/CRAN/refmans/terra/html/terra-package.html) is newer, also supports vector objects. [examples](http://www.wvview.org/os_sa/15_Raster_Analysis_terra.html)
- `raster`, `terra` [comparison](https://www.r-bloggers.com/2021/05/a-comparison-of-terra-and-raster-packages/)

---
## Sample rasters
- CHIRPS data (daily precip)
- Westboro land cover (read from TerrSet file)

```{r}
library(geospaar)
data(chirps) ## load package data
plot(chirps)
```

---
## data structure
```{r}
isS4(chirps) ## returns TRUE -- rasters are S4 objects
```
```{r}
str(chirps)
```


---
## raster properties
- Number of layers
```{r}
nlayers(chirps)
```
- names of layers
```{r}
names(chirps)
```
- projection
```{r}
crs(chirps)
```

---

- rows, columns, layers
```{r}
dim(chirps) ## row, column, nlayers
```

- resolution
```{r}
raster::res(chirps) ## in degrees according to crs
```



---
- getting raster values (returned as multi-dim array)
```{r}
values(chirps) %>% str()
```
- print out values
```{r}
- values(chirps)
```

---

- extent as bounding box

```{r}
extent(chirps)
st_bbox(extent(chirps))
```

---
## Loading TerrSet data
```{r}
westluse <- raster::raster("../inst/extdata/westluse.rst")
westroads <- st_read("../inst/extdata/westroad.vct")
plot(westluse)
plot(westroads, col = 'red', add = T)
```

---
## raster objects
- [Raster classes](https://rspatial.org/raster/pkg/2-classes.html)
- `RasterLayer` object - 1 layer
- `RasterStack` object - many layers, multiple file sources
- `RasterBrick` object - many layers, fast, one file source (good for satellite imagery)

---
## accessing bands
- use list `[[ ... ]]` notation
```{r}
chirps[[3]] ## access by index
#chirps[["Y16301"]] ## access by band name
```

```{r}
plot(chirps[[3]])
```



---
## Creating raster from scratch

- how does `extent` work?
```{r, message = FALSE}
library(raster)
r <- raster(extent(30, 31, -14, -13), res = 0.1, crs = 4326)
values(r) <- sample(1:10, size = ncell(r), replace = TRUE)

par(mar = c(0, 0, 0, 0))
plot(districts %>% st_geometry)
plot(r, add = TRUE)

#plot(r)
```

---
- Creating multi-layer stack

```{r, message = FALSE}
s <- stack(r, log10(r))
names(s) <- c("dummy", "log10dummy")
plot(s)
print(class(s))
#b <- brick(s)
#brick(list(r, log10(r)))
#plot(b)
```


---
- Creating multi-layer brick
- Sample values from 1:10

```{r, message = FALSE}

b2 <- lapply(1:10, function(x) {
  r <- raster(extent(30, 31, -14, -13), res = 0.1, 
              crs = "+proj=longlat +datum=WGS84")
  set.seed(x)
  values(r) <- sample(1:10, size = ncell(r), replace = TRUE)
  r
}) %>% brick
plot(b2)
```

---
### A large brick
- how does this differ from above?
```{r, message = FALSE}
b3 <- lapply(1:10, function(x) {
  r <- raster(extent(30, 31, -14, -13), res = 0.001, 
              crs = "+proj=longlat +datum=WGS84")
  set.seed(x)
  values(r) <- sample(1:10, size = ncell(r), replace = TRUE)
  r
}) %>% stack %>% brick
plot(b3)
plot(b3[[1]])
plot(b3[[10]])
plot(b3[[c(1, 10)]])

```

---

- read and write

```{r, message = FALSE}
## write raster
writeRaster(r, filename = file.path(tempdir(), "mydummy.tif"), overwrite = TRUE)
dir(tempdir())

## read in raster
r <- raster(file.path(tempdir(), "mydummy.tif"))
plot(r)
```

---

- `brick` function can be used both to read and write
```{r, message = FALSE}
## write file
brick(s, filename = "mybrick.tif", overwrite = TRUE)

## read file
newbrick <- brick( "mybrick.tif")
```

-  `raster()` only reads in one layer

```{r, eval = FALSE}
a <- raster(file.path(tempdir(), "mybrick.tif"))
nlayers(a)
```

---

- Projecting
- `projectRaster` 
- similar to `st_transform()`, use crs of existing layer to project
- need to define resolution with `res` argument
```{r, message = FALSE}
roads <- read_sf(system.file("extdata/roads.shp", package = "geospaar"))
chirpsz_alb <- chirpsz %>% projectRaster(., crs = crs(roads), res = 5000) 
chirpsz_alb %>% print()
```

---
- Vector to raster
- `rasterize` converts to raster. Need to pass argument that gives raster dimensions.
- In below example, we use `chirpsz` for dimensions
```{r, message = FALSE}
distsr <- districts %>% rasterize(., chirpsz)
distsr %>% plot_noaxes
print(str(distsr))
# stack(distsr, chirpsz[[1:2]]) %>% plotRGB(stretch = "lin")

```

---

- Raster to vector
- `rasterToPolygons`, use dissolve to merge common raster values
```{r}
distsr_pol <- rasterToPolygons(distsr, dissolve = TRUE)
distsr_pol %>% st_as_sf %>% st_geometry %>% plot
distsr_pol %>% st_as_sf %>% slice(49) %>% plot(add = TRUE)
```




---
- plotting
- run example below individually
```{r, eval = FALSE}
plot(b)
plot(b2)
plot_noaxes(b)
plot_noaxes(b2, main = paste("Random", 1:10))
plot(b2, main = paste("Random", 1:10))
plot_noaxes(b, legend = FALSE)

plot_noaxes(b[[1]], legend = FALSE)
legend("right", legend = 1:10, fill = terrain.colors(10), border = FALSE, 
       bty = "n")

# plotting with larger datasets
plot_noaxes(b3, main = paste("Random", 1:10))
plot_noaxes(b3, nc = 3, nr = 4, main = paste("Random", 1:10))

rasterVis::levelplot(b3)#, #names.attr = paste("Random", 1:10))
rasterVis::levelplot(b2, names.attr = paste("Random", 1:10))
rasterVis::levelplot(b[[1]])
rasterVis::gplot(b[[1]]) + geom_tile(aes(fill = value)) + 
  scale_fill_viridis_c()
ggplot2::ggplot(as.data.frame(b[[1]], xy = TRUE)) + 
  # geom_tile(aes(x = x, y = y, fill = dummy)) + scale_fill_viridis_c()  
  geom_raster(aes(x = x, y = y, fill = dummy)) + scale_fill_viridis_c()
stars::st_as_stars(b) %>% plot(col = viridis::viridis(10))
stars::st_as_stars(b) %>% plot()
```

---
## Raster to other types
```{r, eval=FALSE}
plot(b)
b[1:10]
b[1:ncell(b)]
as.matrix(b)
as.data.frame(b) %>% as_tibble()
```


---
## Pre-processing
- Aggregating/disaggregating
```{r, eval = FALSE}
aggregate(b, fact = 2) %>% plot
# aggregate(b, fun = min, fact = 2) %>% plot
# aggregate(b, fun = sd, fact = 2) %>% plot
plot(b)
disaggregate(b, fact = 2) %>% plot
disaggregate(b, fact = 2, method = 'bilinear') %>% plot()
```

- Masking
```{r, eval = FALSE}
library(geospaar)
data(chirps)
plot_noaxes(chirps[[1]])
chirpsz <- mask(chirps, districts)
plot_noaxes(chirpsz[[1]])
plot(st_geometry(districts), add = TRUE)
# rasterVis::levelplot(chirpsz[[1:5]])
plot_noaxes(chirpsz, nr = 3, nc = 4, maxnl = 12, mar = c(0, 0, 0, 0), 
            legend = FALSE, zlim = c(0, 50))
plot(chirpsz, nr = 3, nc = 4, maxnl = 12, mar = c(0, 0, 0, 0), 
     legend = FALSE, zlim = c(0, 50))
```



---
## Exercises

- Create a dummy raster (sampling from 1:100) using district 49 for extent and res of 0.1
- Reproject to Albers, using `roads` for crs
- Disaggregate to 0.02 degrees (bilinear and NGB)
- Calculate the sum of rainfall from `chirps`
- Identify all areas of total rainfall > 10 mm
- Calculate the mean rainfall in Zambia for the 15th day in `chirps`



---
## HW
- Read Unit 2 Module 2a, Parts 1-2
- [Raster classes](https://rspatial.org/raster/pkg/2-classes.html)











