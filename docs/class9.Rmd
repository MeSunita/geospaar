---
title: "Geospatial Analysis with R"
subtitle: Class 9
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["default", "lucy", "middlebury-fonts", "themes/class9.css"]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r, out.width = "70%", echo=FALSE, fig.align='center'}
# knitr::include_graphics("figures/cnh_figure.png")
```

```{r, eval = FALSE}
# code adapted from example from 
# https://www.r-graph-gallery.com/330-bubble-map-with-ggplot2
library(tidyverse)
library(sf)
library(geospaar)
districts <- read_sf(
  system.file("extdata", "districts.shp", package = "geospaar")
)
farmers <- read_csv(
  system.file("extdata", "farmer_spatial.csv", package = "geospaar")
) %>% group_by(uuid) %>% 
  summarize(x = mean(x), y = mean(y), n = n()) %>%
  filter(y > -18) #%>% st_as_sf(coords = c("x", "y"), crs = 4326)
p <- ggplot() + 
  geom_sf(data = districts, lwd = 0.1) + 
  geom_point(data = farmers, 
             aes(x = x, y = y, size = n, color = n), alpha = 0.9) +
  scale_color_viridis_c(guide = FALSE) + theme_void() + 
  theme(legend.position = c(0.85, 0.2)) +
  scale_size(range = c(0.1, 5), name = "N reports/week")
ggsave(here::here("external/slides/figures/zambia_farmer_repsperweek.png"), 
       width = 6, height = 4, dpi = 300, bg = "grey")
```

---

# Today

- Control structures/looping
- Reading in data
- Reshaping

---

## Looping practice (wrap-up)

- Write a `for` loop that iterates through the vector 1:10 and prints the iterator `i` multiplied by 10

```{r, eval=FALSE}
for(i in 10) i
```

- Do the same, but instead of print `i * 10`, catch the result in a predefined empty list `o`
```{r, eval=FALSE}
for(i in c(1, 10)) {
  o <- i * 10
}
```

- Do the same as above, but use an `lapply` that assigns output to `o`
- Do the same as above, but use `sapply` instead of `lapply`
- Let's use `sapply` to find which elements of `l` are `matrix`
- Let's use `lapply` to calculate the `colMeans` of matrices and `data.frame`s in `l`
---
## Looping practice continued
### First let's create some new data
```{r, eval=FALSE}
set.seed(100)
m1 <- cbind(V1 = 1:20, V2 = sample(1:100, size = 20, replace = TRUE), 
            V3 = rnorm(n = 20, mean = 500, sd = 100))
```

- Create an `m2` and `m3` with the same settings, but use a seed of 200 for `m2` and 300 for `m3`.  

---

## Looping
### Create a list of matrices
- Create the matrices `m1`, `m2`, `m3` using an `lapply`: 
- Ingredients:
  - vector to iterate over: `c(100, 200, 300)`
  - output object: `l`
  - anonymous function to create each matrix: 
  
```{r, eval = FALSE}
function(x) {
  m <- cbind(...)  
}
```

---
## Looping 2
### Create list of data.frames
- Create a list `l2` with three data.frames, having the same variables `V1:V3` as in m, but with a 4th variable `GRP` that is sampled from the first 5 values of `LETTERS`
- Ingredients:
  - Same code used to make `l`
  - Within the anonymous function, make a fourth variable `v` using `sample` below the code to make `m`
  - Combine `m` and `v` (naming it `GRP`) using `data.frame`

---
## Reading/writing data

Let's first write some data and read it back in:
```{r, eval=FALSE}
dummy_data <- data.frame(a = 1:10, b = sample(letters[1:5], 10, replace = TRUE))

# two ways of writing
write.csv(dummy_data, file = "~/Desktop/demo/dummy_data.csv")
readr::write_csv(dummy_data, file = "~/Desktop/demo/dummy_data.csv")

# two ways of reading
read.csv("~/Desktop/demo/dummy_data.csv")
readr::read_csv("~/Desktop/demo/dummy_data.csv")
```

---
## Reading/writing data
With a bit of reshaping to start

- Let's take `l2` from the previous exercise
- Combine it into a single `data.frame` using the following code
```{r, eval=FALSE}
d <- do.call(rbind, l2)
```

- Now write that out using `write.csv` and `readr::write_csv`
- And read it back in using `read.csv` and `readr::read_csv`

---
## Reading/writing and looping

- Let's write `l2` out using a `for` loop to create three output csv files
```{r, eval=FALSE}
for(i in 1:length(l2)) {
  write.csv(l2[[i]], file = paste0("~/Desktop/demo/dummy_data", i, ".csv"))
}
```

- And read those back into a list: use `lapply` to capture data in list `l3`
- Ingredients:
  - Iterate over `1:3`
  - Have `read.csv` in anonymous function body
  - Reuse the `paste0` from code chunk above
  
---
## Reshaping data

Going from long to wide and back again
```{r, eval=FALSE}
library(dplyr)
library(tidyr)

# d1 <- data.frame(a = 1:10, grp1 = rep("a", 10), grp2 = rep("b", 10))
d1 <- data.frame(i = 1:10, a = 1:10, grp = rep("a", 10))
d2 <- data.frame(i = 1:10, a = 11:20, grp = rep("b", 10))
DF <- rbind(d1, d2)

df_wide <- DF %>% pivot_wider(names_from = grp, values_from = a)
df_long <- df_wide %>% 
  pivot_longer(cols = a:b, names_to = "grp", values_to = "a")

```

- Reorder columns and sort grp





















