---
title: "Geospatial Analysis with R"
subtitle: Class 20
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["default", "lucy", "middlebury-fonts", "themes/class18.css"]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

## Today

- Homework review
- Leaflet, 
- Projects

---

## HW
- new data set
```{r, message = F, warning = F}
library(geospaar)
library(raster)

## read in temperature data
temps <- brick("C:/Users/micha/Downloads/global_temps (1).tif")

## read in and reproject districts
districts <- st_read(system.file("extdata/districts.shp", package = "geospaar"))
districts_rpj <- st_transform(districts, crs(temps))
## mask and crop temperatures, and disaggregate (so there are enough raster cells to cover all districts)
temps_mask <- mask(temps, districts_rpj) %>%
  crop(., districts_rpj) %>% 
  raster::disaggregate(fact = 10, method = 'bilinear')

## add ID field for districts, and rasterize
districts_rpj$ID <- 1:NROW(districts_rpj)
distsr <- districts_rpj %>% raster::rasterize(x = ., y = temps_mask[[1]]) 
distsr_rs <- resample(x = distsr, y = temps_mask, method = "ngb")
```


---
### mapView
- quick viz of raster/vector layers and basemaps
- [reference](https://r-spatial.github.io/mapview/)
- [examples](https://r-spatial.github.io/mapview/articles/mapview_02-advanced.html)
```{r, message = F, warning = F}
library(mapview)
#mapview(districts)
mapview(districts %>% st_geometry(), fill = NA, color = 'red')
```

---
### mapView
- 3 color raster composite
```{r, message = F, warning = F}
mapview::viewRGB(x = chirpsz[[1:3]])
```

---
### mapView
- raster + vector layers

```{r, message = F, warning = F}
mapView(districts, alpha.regions = 0, legend = FALSE) + 
  mapview(raintot)
```

---
### mapView
```{r, message = F, warning = F}
kili_data <- system.file("extdata", "kiliNDVI.tif", package = "mapview") %>%
  raster::stack(.)
mapview(kili_data[[c(1, 10, 23)]])
```


---
### tmap
- [thematic maps](https://cran.r-project.org/web/packages/tmap/vignettes/tmap-getstarted.html)
- works well for raster bins
```{r, message = F, warning = F}
library(tmap)
data(World)
# tmaptools::palette_explorer()
tm_shape(raintot) + 
  tm_raster(palette = "magma", breaks = seq(0, 200, 25)) +
  tm_shape(districts) + tm_borders() + 
  tm_layout(bg.color = "grey", inner.margins = 0.1) # +
  # tm_shape(World) + tm_borders()
```

---

### leaflet
- [Examples](https://rstudio.github.io/leaflet/)
- [Shiny apps](https://rstudio.github.io/leaflet/shiny.html)
```{r, message = F, warning = F}
library(leaflet)
m <- leaflet() %>% addTiles()
# # m  # a map with the default OSM tile layer
# 
m %>% addProviderTiles("Esri.WorldImagery")
# 
# # set bounds
# m %>% fitBounds(0, 40, 10, 50)
# #
# # # move the center to Snedecor Hall
# m <- m %>% setView(-93.65, 42.0285, zoom = 17)
# m
# #
# # popup
# # m %>% addPopups(-93.65, 42.0285,
# #                 "Here is the <b>Department of Statistics</b>, ISU")
rand_lng <- function(n = 10) rnorm(n, -93.65, .01)
rand_lat <- function(n = 10) rnorm(n, 42.0285, .01)

# use automatic bounds derived from lng/lat data
m <- m %>% clearBounds()

# popup
m %>% addPopups(rand_lng(), rand_lat(), paste0("Random popup ", 1:10) )
```

---


### RStoolbox
- (no longer supported on CRAN)
- create raster composites, plots
```{r, message = F, warning = F}
library(RStoolbox)
data(lsat)
ggRGB(lsat, stretch = "lin")
ggRGB(lsat[[2:4]], stretch = "lin")
ggR(lsat[[1]])
ggR(lsat[[1]], stretch = "hist")
ggR(lsat[[1]], stretch = "lin")
ggR(raintot)
ggR(raintot) + 
  theme_linedraw() + xlab("") + ylab("")
  # theme_void()
```

---

### RStoolbox::spectralIndices
- calculate VI's with `spectralIndices`
- ggplot rasters with `ggR`

```{r, message = F, warning = F}
ndvi <- spectralIndices(lsat, red = "B3_dn", nir = "B4_dn", indices = "NDVI")
ggR(ndvi, geom_raster = TRUE) +
  scale_fill_gradientn(colours = c("black", "white"))
  # scale_fill_viridis_c()
```

---
### RStoolbox
- radiometric calibration with `radCor`
- many VI's

```{r, message = F, warning = F}
mtlFile  <- system.file("external/landsat/LT52240631988227CUB02_MTL.txt", 
                        package = "RStoolbox")
lsat_ref <- radCor(lsat, mtlFile, method = "apref")

SI <- spectralIndices(lsat_ref, red = "B3_tre", nir = "B4_tre")
plot(SI)
#?spectralIndices
# rasterVis::levelplot(SI)
```


---
### Plotly
- interactive, `ggplot` style maps (great for vector data)
Many examples in code demos section of `plotly` help

```{r, message = F, warning = F}
library(plotly)
library(sf)

nc <- sf::st_read(system.file("shape/nc.shp", package = "sf"), quiet = TRUE)
p <- ggplot(nc) + geom_sf(aes(fill = AREA))
ggplotly(p)
ggplot() + geom_sf(data = nc, aes(fill = AREA)) ## no interactivity in standard ggplot
```

---
### Plotly
- [Gallery](https://plotly.com/r/maps/)
```{r, message = F, warning = F}
# If not supplied, coord_sf() will take the CRS from the first layer
# and automatically transform all other layers to use that CRS. This
# ensures that all data will correctly line up
nc_3857 <- sf::st_transform(nc, "+init=epsg:3857")
p2 <- ggplot() +
  geom_sf(data = nc) +
  geom_sf(data = nc_3857, colour = "red")#, aes(fill = AREA))
plot(p2)
ggplotly(p2)
```


---

### Plotly cont.
- Plot layer with different symbology
```{r, message = F, warning = F}
# Unfortunately if you plot other types of feature you'll need to use
# show.legend to tell ggplot2 what type of legend to use
nc_3857$mid <- sf::st_centroid(nc_3857$geometry)
p3 <- ggplot(nc_3857) +
  geom_sf(colour = "white") +
  geom_sf(aes(geometry = mid, size = AREA), show.legend = "point")
ggplotly(p3)
```

---
### Plotly
- Add additional layer
```{r, message = F, warning = F}
# You can also use layers with x and y aesthetics: these are
# assumed to already be in the common CRS.
p4 <- ggplot(nc) +
  geom_sf() +
  annotate("point", x = -80, y = 35, colour = "red", size = 4)
ggplotly(p4)
```



---

## Projects
- [Project overview](https://agroimpacts.github.io/geospaar/projects.html#project-overview-assignment) due Sunday 4/16
- Project updates each class showing
  - commits to project repo
  - new analysis, plots, charts etc. 

---
## Project advice
- [Division of labor](https://agroimpacts.github.io/geospaar/projects.html#project-overview-assignment)
- Start small, then scale up





