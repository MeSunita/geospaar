---
title: "Geospatial Analysis with R"
subtitle: Class 17
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["default", "lucy", "middlebury-fonts", "themes/class18.css"]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

## Today

- Parallelization
- Exercises from last class
- New exercises (teams)

---
## Data

```{r, warning=FALSE, message=FALSE, results='hide'}
library(geospaar)
districts <- system.file("extdata/districts.shp", package = "geospaar") %>%
  st_read
data(chirps)
chirpsz <- mask(chirps, districts)
```

---


## Mac/Linux parallelization
```{r, eval=FALSE}
library(parallel)
system.time(b3 <- lapply(1:250, function(x) {
  r <- raster(extent(30, 31, -14, -13), res = 0.001, 
              crs = "+proj=longlat +datum=WGS84")
  set.seed(x)
  values(r) <- sample(1:10, size = ncell(r), replace = TRUE)
  stack(r, r * runif(n = ncell(r), 0.9, 1.2), r * runif(n = ncell(r), 0.8, 1.3))
})) 

system.time(b4 <- mclapply(1:250, function(x) {
  r <- raster(extent(30, 31, -14, -13), res = 0.001, 
              crs = "+proj=longlat +datum=WGS84")
  set.seed(x)
  values(r) <- sample(1:10, size = ncell(r), replace = TRUE)
  stack(r, r * runif(n = ncell(r), 0.9, 1.2), r * runif(n = ncell(r), 0.8, 1.3))
}, mc.cores = 7)) 

system.time(l1 <- lapply(b3, function(x) calc(x, mean)))
system.time(l2 <- mclapply(b4, function(x) calc(x, mean), mc.cores = 7))
```

---
## Windows parallelization

```{r, eval=FALSE}
detectCores()
cl <- makeCluster(8)
rast_fun <- function(x) {
  r <- raster(extent(30, 31, -14, -13), res = 0.001, 
              crs = "+proj=longlat +datum=WGS84")
  set.seed(x)
  values(r) <- sample(1:10, size = ncell(r), replace = TRUE)
  stack(r, r * runif(n = ncell(r), 0.9, 1.2), r * runif(n = ncell(r), 0.8, 1.3))
}
clusterEvalQ(cl, library(raster))
system.time(l3 <- parLapply(cl, 1:250, function(x) {
  r <- raster(extent(30, 31, -14, -13), res = 0.001, 
              crs = "+proj=longlat +datum=WGS84")
  set.seed(x)
  values(r) <- sample(1:10, size = ncell(r), replace = TRUE)
  stack(r, r * runif(n = ncell(r), 0.9, 1.2), r * runif(n = ncell(r), 0.8, 1.3))
}))
stopCluster(cl)
```

---
## Exercises
### Last class
- Create a dummy raster (sampling from 1:100) using district 49 for extent and res of 0.1 
- Reproject to Albers 
- Disaggregate to 0.02 degrees (bilinear and NGB) 
- Calculate the sum of rainfall from `chirpsz`
- Identify all areas of total rainfall > 10 mm
- Calculate the mean rainfall in Zambia for the 15th day in `chirpsz`

---

### Data
```{r, warning=FALSE, message=FALSE, results='hide'}
library(geospaar)
farmers <- system.file("extdata/farmer_spatial.csv", package = "geospaar") %>%
  read_csv %>% distinct(uuid, .keep_all = TRUE) %>% select(uuid, x, y) %>% 
  mutate(count = 1) %>% st_as_sf(coords = c("x", "y"))
roads <- system.file("extdata/roads.shp", package = "geospaar") %>% st_read
districts <- system.file("extdata/districts.shp", package = "geospaar") %>%
  st_read
chirpsz <- mask(chirps, districts)
```

- Dummy raster
```{r, eval=FALSE}
e <- districts %>% slice(49) %>% extent()
r <- raster(e, res = 0.1, crs = 4326)
r[] <- sample(1:100, size = ncell(r), replace = TRUE)

plot(r)
plot(aggregate(r, fact = 2))
plot(disaggregate(r, fact = 2, method = "bilinear"))
```

---

### New
- From `chirpsz`, create a categorical raster (`raincat`) containing legend with "low", "medium", "high" rainfall from `raintot`, wherein the low is areas with rainfall < 50 mm, medium is 50-100 m, and high is rainfall > 100 mm
- Calculate the local standard deviation of `raintot` in a 5X5 moving window. Remove NAs from the calculation so the boundaries are not shrunk
- Calculate the average elevation and slope in each district of Zambia



