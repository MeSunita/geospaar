---
title: "Geospatial Analysis with R"
subtitle: Class 11
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: ["default", "lucy", "middlebury-fonts", "themes/class4plus.css"]
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r, out.width = "100%", echo=FALSE, fig.align='center'}
knitr::include_graphics("figures/tanzam_rainfall.png")
```

---


```{r, eval=FALSE}
tz <- st_read(here::here("external/data/tanzania.geojson"))
sagcot <- st_read(here::here("external/data/sagcotcl.geojson"))
zambia <- st_read(
  system.file("extdata/districts.shp", package = "geospaar")
) %>% st_union()
prec <- raster::getData(name = "worldclim", var = "prec", res = 2.5)

precsum <- terra::app(terra::rast(prec), sum)
tz_sagcot <- terra::vect(st_union(sagcot, zambia))
prec_tzzam <- terra::mask(terra::crop(precsum, tz_sagcot), tz_sagcot)

prec_stars <- stars::st_as_stars(raster::raster(prec_tzzam))
p <- ggplot() + 
  geom_sf(data = tz) +  
  stars::geom_stars(data = prec_stars) +
  scale_fill_viridis_c(name = "Rainfall (mm)", na.value = "transparent") + 
  geom_sf(data = zambia, fill = "transparent") +
  geom_sf(data = sagcot, fill = "transparent") +
  labs(x = NULL, y = NULL) +
  theme_linedraw()
ggsave(p, filename = "docs/figures/tanzam_rainfall.png", height = 4, 
       width = 7, units = "in", dpi = 300)  
```



---
## Homework 
Plot values by groups, `ggplot` version

### Data
```{r, warning=FALSE, message=FALSE}
library(tidyverse)
set.seed(1)
price_weight_long <- tibble(
  year = 1951:2000, 
  price = runif(n = length(year), 20, 50),
  weight = (price * 10) * runif(n = length(year), 0.8, 1.2)
) %>% 
  pivot_longer(cols = price:weight, names_to = "element", values_to = "value")
price_weight_long
```
---
## The base way
```{r, out.width="60%", fig.align='center'}
plot(value ~ year, col = "red", pch = 16, 
     ylim = range(price_weight_long$value),
     data = price_weight_long[price_weight_long$element == "price", ])
points(value ~ year, col = "blue", pch = 16, 
       data = price_weight_long[price_weight_long$element == "weight", ])
```

---
## ggplot solution?

```{r, fig.align='center', out.width="40%"}
p <- price_weight_long %>% 
  ggplot() + geom_point(aes(x = year, y = value, color = element)) +
  xlab("Year") + ylab("value") + 
  ggtitle("Relation between year and value") + # Shiqi's solution
  theme(
    text = element_text(size = 20),
    panel.background = element_rect(fill = "white"),
    plot.title = element_text(hjust = 0.5),
  )  # Galen's tweak
p
```


---
## New data
```{r}
library(tidyverse)
set.seed(1)
tb_df <- tibble(year = rep(1951:2000, 2), 
                group = rep(sample(letters[1:5], 50, replace = TRUE), 2), 
                value = runif(n = 100, min = 50, max = 100),
                element = c(rep("Price", 50), rep("Weight", 50)))
```

- Use `readr::write_csv` to write out `tb_df` to your `~/Desktop` to a csv file named `dummy_data2.csv`. 

```{r}
readr::write_csv(tb_df, file =  "~/Desktop/dummy_data2.csv")
# write.csv(tb_df, file =  "~/Desktop/dummy_data2.csv") # names rows by default :()
```


---
## Data shaping

- Use `readr::read_csv` to read `dummy_data2.csv` into `tb_df`
- Determine the unique (distinct) values in the *group* and *element* columns
- Closely related example:

```{r}
price_weight_long %>% distinct(element)
```
```{r, message=FALSE, warning=FALSE}
tb_df <- readr::read_csv("~/Desktop/dummy_data2.csv") 
tb_df %>% distinct(group, element)
# tb_df %>% select(group, element) %>% View()
```


---

- Spread `tb_df` so that "Price" and "Element" have their own columns
- `pivot_wider` is your friend
- Related:

```{r, eval = FALSE}
price_weight_wide <- price_weight_long %>% 
  pivot_wider(names_from = element, values_from = value)
```
```{r}
tb_df_wide <- tb_df %>% 
  pivot_wider(names_from = element, values_from = value)
```

---

- Spread `tb_df` so that "Price" and "Element" have their own columns, but exclude the *group* variable

```{r}
tb_df %>% select(-group) %>% 
  pivot_wider(names_from = element, values_from = value)
# tb_df[, -grep("group", colnames(tb_df))]
# tb_df[, -grep("group", colnames(tb_df))]
```

---
- Redo the `pivot_wider` that includes *group*, and then arrange by *group*
```{r}
tb_df %>% 
  pivot_wider(names_from = element, values_from = value) %>% 
  arrange(group)
```

---
- Redo the `pivot_wider` that includes *group*, and then arrange by *group* and by *year*, with *year* in descending order
```{r}
tb_df %>% 
  pivot_wider(names_from = element, values_from = value) %>%  
  arrange(group, desc(year))
```

---
- Calculate a new column that describes the weight:price ratio, name it `wt_price`

```{r}
tb_df %>% 
  pivot_wider(names_from = element, values_from = value) %>%  
  mutate(wt_price = Weight / Price)
```

---
- Do the same as above, but calculate the average `weight`, `price`, and `wt_price` for each group

```{r}
tb_df %>%
  pivot_wider(names_from = "element", values_from = "value") %>% 
  mutate(wt_price = Weight / Price) %>% group_by(group) %>% 
  summarize(price = mean(Price), weight = mean(Weight), 
            wt_price = mean(wt_price))

tb_df %>% 
  pivot_wider(names_from = element, values_from = value) %>% 
  mutate(wt_price = Weight / Price) %>% 
  group_by(group) %>% 
  # summarise_all(funs(mean = mean)) %>% 
  summarise_all(list(mean))
```


---

- A little extra
```{r, eval=FALSE}
tb_df %>% pivot_wider(names_from = element, values_from = value) %>% 
  arrange(group, desc(year)) %>%
  filter(group == "a") %>% mutate(wt_price = Weight / Price)

```

```{r, echo=FALSE}
# tb_df <- readr::read_csv(here::here("external/notebooks/data/dummy_data.csv"))
# tb_df %>% distinct(group, element)
# tb_df %>% pivot_wider(names_from = element, values_from = value)
# tb_df %>% select(-group) %>% 
#   pivot_wider(names_from = element, values_from = value)
# tb_df %>% 
#   pivot_wider(names_from = element, values_from = value) %>% 
#   arrange(group)
# tb_df %>% pivot_wider(names_from = element, values_from = value) %>% 
#   arrange(group, desc(year))
# tb_df %>% pivot_wider(names_from = element, values_from = value) %>%
#   mutate(wt_price = Weight / Price)
```

---
## Plotting

- Let's do a scatter plot, with Price on the x axis and weight on the y axis

```{r, out.width = "60%", echo=FALSE, fig.align='center'}
tb_df %>% 
  pivot_wider(names_from = element, values_from = value) %>%  
  mutate(wt_price = Weight / Price) %>% 
  ggplot() + geom_point(aes(x = Price, y = Weight))
```

---
- Let's plot a line graph of Price (y axis) against year (x axis)

```{r, out.width = "70%", echo=FALSE, fig.align='center'}
tb_df %>% 
  pivot_wider(names_from = element, values_from = value) %>%  
  mutate(wt_price = Weight / Price) %>% 
  ggplot() + geom_line(aes(x = year, y = Price))
```

---
- Calculate the mean Weight and Price by year, and plot as an XY scatter

```{r, out.width = "70%", echo=FALSE, fig.align='center'}
tb_df %>% 
  pivot_wider(names_from = element, values_from = value) %>%  
  group_by(year) %>% select(-group) %>% 
  summarize_all(list(mean)) %>% 
  ggplot() + geom_point(aes(x = Weight, y = Price))
```
---
- Plot Weight against Year as a line plot, with a separate series for each group
```{r, out.width = "70%", echo=FALSE, fig.align='center'}
tb_df %>% 
  pivot_wider(names_from = element, values_from = value) %>%  
  ggplot() + geom_line(aes(x = year, y = Weight, color = group))
```
---
- Let's calculate a histogram of wt_price
```{r, out.width = "70%", echo=FALSE, fig.align='center'}
tb_df %>% 
  pivot_wider(names_from = element, values_from = value) %>%  
  mutate(wt_price = Weight / Price) %>% 
  ggplot() + 
  geom_histogram(aes(x = wt_price), color = "black", fill = "blue", bins = 20)
```
---
- Do the same, but let's make a histogram for each group. 
```{r, out.width = "70%", echo=FALSE, fig.align='center'}
tb_df %>% 
  pivot_wider(names_from = element, values_from = value) %>%  
  mutate(wt_price = Weight / Price) %>% 
  ggplot() + 
  geom_histogram(aes(x = wt_price), color = "black", fill = "blue", bins = 20) +
  facet_wrap(facets = ~group)
```


