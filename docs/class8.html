<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Geospatial Analysis with R</title>
    <meta charset="utf-8" />
    <script src="libs/header-attrs-2.20/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/lucy.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/middlebury-fonts.css" rel="stylesheet" />
    <link rel="stylesheet" href="themes/class8.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# Geospatial Analysis with R
]
.subtitle[
## Class 8
]

---


```r
library(sf)
library(dplyr)
library(ggplot2)
library(rnaturalearth)
library(rnaturalearthdata)
data(world.cities, package = "maps")

world &lt;- ne_countries(scale = "medium", returnclass = "sf")
afr_capitals &lt;- world.cities %&gt;% filter(capital == 1) %&gt;% 
  st_as_sf(coords = c("long", "lat"), crs = 4326) %&gt;% 
  st_intersection(., world %&gt;% filter(continent == "Africa"))
p &lt;- world %&gt;% filter(continent == "Africa") %&gt;% 
  ggplot() + geom_sf(aes(fill = name), lwd = 0.2) + 
  geom_sf(data = afr_capitals, col = "blue", size = 0.5) + 
  scale_fill_grey(guide = FALSE) + theme_minimal()
ggsave(here::here("external/slides/figures/africa_capitals.png"), 
       width = 5, height = 4, dpi = 300, bg = "transparent")
```

---


```r
library(stars)
tif &lt;- system.file("tif/L7_ETMs.tif", package = "stars")
x &lt;- read_stars(tif)
plot(x, axes = TRUE)
plot(x[, , , 4:2], axes = TRUE)

s3url &lt;- glue::glue("/vsis3/activemapper/",
                    "planet/composite_sr_buf_fix/GS/",
                    "tile486317_736815_736967.tif")  # not accessible
p &lt;- read_stars(s3url, proxy = TRUE)
plot(p[, , , 1:3])
```

See [here](https://r-spatial.github.io/stars/articles/stars1.html) for more details.

---
## Let's - a -go


---
## MarioKart 

We will examine data from sample MarioKart races. First, let's generate results for 10 races and 4 drivers.

Setup: Create an empty data-frame with 4 columns as follows.

```r
DF &lt;- data.frame(mario = integer(),
                luigi = integer(),
                bowser = integer(),
                yoshi = integer())
```

---
## for loop

Use a for loop to fill in the rows 1:10 with the finishing position of each racer. So you should used `sample` to determine finishing order with 4 racers.

Setup: Create an empty data-frame with 4 columns as follows.

```r
for(k in 1:10){
  DF[k, ] &lt;-  sample(1:4, 4)       ## fill in code here for the kth row
  
}
DF
```

Add row names "race 1", "race 2" etc. Use `paste0`

```r
rownames(DF) &lt;-  paste0("race ", 1:10)       ## add code here
```
---
## apply work

Calculate the average finishing place of each racer using `apply`. Which dimension will you use? (1 = column, 2 = row).

Which racer had the best average finish?


```r
average_finish &lt;- apply(DF, 2, FUN = mean) ## fill in code for apply
```


---
## apply work

Now create a new column, `first_place_name` that lists which racer finished first.

You will want to do this in two steps. First use `apply` to get the index of the first place finisher in each row. (hint: you'll want to use one of the `which` functions)


```r
DF$first_place &lt;- apply(DF, 1, which.min) ## fill in code
```

Then create the `first_place_name` column that uses the racer names. 


```r
racer_names &lt;- colnames(DF)[1:4]
DF$first_place_names &lt;- racer_names[DF$first_place]
```


---
## Scenario 2.

We will create a new data frame, `DF2`, with one column for each racer. Instead of using `sample` to get the final place, use `runif` to draw each racer's final time from a uniform distribution between 20 and 30 seconds.  


```r
DF &lt;- data.frame(mario = integer(),
                luigi = integer(),
                bowser = integer(),
                yoshi = integer())

for(k in 1:10){
  DF[k, ] &lt;-  runif(...)       ## fill in code here for the kth row
  
}
```

Again create a column `first_place_name` for the first_place finisher.

Also, create a column `close_race` that is TRUE if the first and last place finishers are within 5 seconds of each other. 

---
## CHALLENGE

Use `rnorm` to determine each racer's times. You will need to fill in the times by column, instead of by row. 
Assume each racer has an average time of 25 seconds, but with different standard deviations. 

Generate data for 1000 races. How often did each driver win?


---
## Assignment 2
- Some small changes made. Be sure to check for updates by reloading website. 



---
# Programming tip

- Whenever possible, let the computer do your counting for you:

```r
a &lt;- 1:1001
a[length(a)]
```

```
## [1] 1001
```
- Rather than 

```r
a[1001]
```

```
## [1] 1001
```
- Imagine this case:

```r
set.seed(1)
b &lt;- 1:sample(1:10000, 1)
b[length(b)]
```

```
## [1] 1017
```

---
## Error message
- `Error: attempt to use zero-length variable name` message
- This occurs in RMD when you have an R chunk immediately followed by a page break `---`
- Add an extra line between R chunk and page break.


---


# Today

- `tidyverse` and `dplyr`
- Reading and writing non-spatial data
- Data preparation/shaping

---

## Next module
- Basic analyses
- Visualization (non-spatial)

---

## data.frame vs. tibble vs data.table
- [good overview](https://jtr13.github.io/cc21fall2/comparison-among-base-r-tidyverse-and-datatable.html)
- Today we will compare `data.frame` and `tibble`
- `data.table` is fast, but its syntax is quite different so we will not use it.

---
## [Advantages of tibble](https://cran.r-project.org/web/packages/tibble/vignettes/tibble.html)
- Doesn't change input data type (i.e. doesn't convert strings to factors)
- No row names (rationale: if row name contain important information, they should be placed in a variable)
- Works well with tidy data

---
## What is tidy data?
- In tidy data:
  - Each variable forms a column.
  - Each observation forms a row.
  - Each type of observational unit forms a table.
  
---
## What is tidy data?
- The `tidyverse` packages (`dplyr`, `ggplot2`) are designed to work with tidy data.
- Messy data is any other arrangement of the data.

---
## `dplyr` syntax
- [Style guide](https://style.tidyverse.org/pipes.html). Please read.
- Pipe operator ` %&gt;% ` is used often with `dplyr`.
- ` %&gt;% ` works left to right, evaluating first function, and sending it as input to next function.

Example. What is this code doing?

```r
library(dplyr)
b &lt;- sample(1:100, 10)
print(b)
```

```
##  [1] 68 39  1 34 87 43 14 82 59 51
```

```r
a &lt;- b %&gt;% max() %&gt;% sqrt()
a
```

```
## [1] 9.327379
```

---
## `dplyr` syntax

```r
data_tib &lt;- readr::read_csv("~/geospaar/inst/extdata/cdf_corn.csv")
site_summary &lt;- data_tib %&gt;% group_by(site_id) %&gt;% summarise(maxNDVI = max(NDVI))
print(site_summary)
```

```
## # A tibble: 38 × 2
##    site_id         maxNDVI
##    &lt;chr&gt;             &lt;dbl&gt;
##  1 UNLEN_CSP1_IMZ1  NA    
##  2 UNLEN_CSP1_IMZ2   0.891
##  3 UNLEN_CSP1_IMZ3   0.909
##  4 UNLEN_CSP1_IMZ5   0.933
##  5 UNLEN_CSP1_IMZ6   0.892
##  6 UNLTAPS_SDI_01a   0.897
##  7 UNLTAPS_SDI_01b   0.906
##  8 UNLTAPS_SDI_02a   0.912
##  9 UNLTAPS_SDI_02b   0.897
## 10 UNLTAPS_SDI_03b   0.910
## # … with 28 more rows
```

---
## Ground sensor data
- We'll look at ground sensor data for sites in Nebraska and California.
- These sensors measure surface reflectance in specific bands. 

&lt;img src="figures/class8_MarkSensor.png" width="40%" height="40%" style="display: block; margin: auto;" /&gt;

---
## Reading data
Base R


```r
data_df &lt;- read.csv("~/geospaar/inst/extdata/cdf_corn.csv")
data_df
```

Tidyr

```r
data_tib &lt;- readr::read_csv("~/geospaar/inst/extdata/cdf_corn.csv")
data_tib
```

---
## Selecting data (rows)

Select rows from site "UNLEN_CSP1_IMZ1" 

Base R 

```r
data_df[data_df$site_id == "UNLEN_CSP1_IMZ1", ]
```

Tidyr


```r
data_tib %&gt;% filter(site_id == "UNLEN_CSP1_IMZ1")
```

Q: How to get observations at site "UNLEN_CSP1_IMZ1" where NDVI is higher than 0.8?

---
## Selecting data (columns)

Select rows from site "UNLEN_CSP1_IMZ1". Only include columns for "local", "lat", "long", "NDVI". 

Base R 

```r
data_df[data_df$site_id == "UNLEN_CSP1_IMZ1", c("local", "lat", "long", "NDVI")]
```

Tidyr


```r
data_tib %&gt;% filter(site_id == "UNLEN_CSP1_IMZ1") %&gt;% select(local, lat, long, NDVI)
```

What differences do you observe?

---
## Renaming data

Rename "local" to "time", and "site_id" to "site"

Base R- CLUNKY, prone to error

```r
colnames(data_df)[colnames(data_df) %in% c("local", "site_id")] =c("time", "site")
```

Tidyr - must store in object to make changes permanent.


```r
data_tib %&gt;% rename(time = local, site = site_id)   ## new name = old_name
data_tib ## name change is not permanent
```


```r
data_tib &lt;- data_tib %&gt;% rename(time = local, site = site_id)   ## new name = old_name
data_tib ## name change IS permanent
```

---
## Creating a new column

The band correspondence for Mark sensor data is [here](https://www.arable.com/wp-content/uploads/2021/10/Arable-Mark-2-w_-Solar-Product-Specifications-20_10.pdf)

We'd like to create a column for the simple ratio = NIR/red. Let's use the NIR1 band for near-infrared reflectance. 

Base R

```r
data_df$SR &lt;- data_df$b6r/data_df$b4r
```

Tidyr

```r
data_tib &lt;- data_tib %&gt;% mutate(SR = b6r/b4r)
```

---
## Grouping data into another tible 

Create a tibble summarizing data. 

TidyR

```r
data_tib %&gt;% group_by(site) %&gt;%  summarize(count = n(),
                                          max_ndvi = max(NDVI, na.rm = T)
                                          ) 
```

```
## # A tibble: 38 × 3
##    site            count max_ndvi
##    &lt;chr&gt;           &lt;int&gt;    &lt;dbl&gt;
##  1 UNLEN_CSP1_IMZ1    24    0.863
##  2 UNLEN_CSP1_IMZ2   100    0.891
##  3 UNLEN_CSP1_IMZ3    99    0.909
##  4 UNLEN_CSP1_IMZ5   336    0.933
##  5 UNLEN_CSP1_IMZ6   100    0.892
##  6 UNLTAPS_SDI_01a   142    0.897
##  7 UNLTAPS_SDI_01b   142    0.906
##  8 UNLTAPS_SDI_02a   145    0.912
##  9 UNLTAPS_SDI_02b    40    0.897
## 10 UNLTAPS_SDI_03b   562    0.910
## # … with 28 more rows
```

Q: What does `n()` do? what about `na.rm`?

---
## More complex column calculations

Finding date of max NDVI


```r
site_data &lt;- data_tib %&gt;% group_by(site) %&gt;%  summarize(count = n(),
                                          max_ndvi = max(NDVI, na.rm = T),
                                          max_ndvi_date = time[which.max(NDVI)]
                                          ) 
site_data
```

```
## # A tibble: 38 × 4
##    site            count max_ndvi max_ndvi_date      
##    &lt;chr&gt;           &lt;int&gt;    &lt;dbl&gt; &lt;dttm&gt;             
##  1 UNLEN_CSP1_IMZ1    24    0.863 2020-06-26 15:00:00
##  2 UNLEN_CSP1_IMZ2   100    0.891 2020-07-08 15:00:00
##  3 UNLEN_CSP1_IMZ3    99    0.909 2020-07-08 15:00:00
##  4 UNLEN_CSP1_IMZ5   336    0.933 2020-08-10 15:00:00
##  5 UNLEN_CSP1_IMZ6   100    0.892 2020-07-08 15:00:00
##  6 UNLTAPS_SDI_01a   142    0.897 2020-07-03 15:00:00
##  7 UNLTAPS_SDI_01b   142    0.906 2020-07-13 15:00:00
##  8 UNLTAPS_SDI_02a   145    0.912 2020-07-13 15:00:00
##  9 UNLTAPS_SDI_02b    40    0.897 2020-07-13 15:00:00
## 10 UNLTAPS_SDI_03b   562    0.910 2020-07-13 15:00:00
## # … with 28 more rows
```

---
## Sorting

Base R - CLUNKY

```r
site_data[order(site_data$count ,decreasing=TRUE),]
```
tidyr

```r
site_data %&gt;% arrange(count) ## arrange ascending
site_data %&gt;% arrange(-count) ## arrange descending
```


---
## Dplyr functions
- There are MANY `dplyr` functions. We have just looked at a handful.
- See `dplyr` [cheatsheet](https://www.rstudio.com/wp-content%2Fuploads%2F2015%2F02%2Fdata-wrangling-cheatsheet.pdf%2F)
- Common `dplyr` [functions](https://dplyr.tidyverse.org/reference/index.html)


---
## Practice (1)

Create a short script that does the following.
- Loads `dplyr` library
- Uses `readr::read_csv` to read in sensor data into a tibble `data_tib`
- Uses `mutate` to create new column for GCVI index.
  - Sensor bands are [here](https://www.arable.com/wp-content/uploads/2021/10/Arable-Mark-2-w_-Solar-Product-Specifications-20_10.pdf). Use band 6 as the NIR band.
  - Google formula for GCVI (Green Chlorophyll Veg Index). 
  
---
## Practice (2)
- Install the `lubridate` package, and load it.
- Apply the `as_date` function to the column `local`. Use this to create a new column `date`, that stores the date as a `Date` object.
- [Lubridate cheat sheet](https://github.com/rstudio/cheatsheets/blob/main/lubridate.pdf)



---
## Practice (3)

- As in the example above, create a new tibble, `site_data`, using `group_by` and `summarize`.
- Use `site` as the grouping variable, and include columns for the following:
  - Median lat and median long (why is `median` better than `mean`)
  - Max NDVI and max GCVI
  - Date of max NDVI and date of max GCVI
- `Lubridate` allows us to subtract dates and find their difference in days. Use this to create a new column `date_diff` in `site_data`. This column should show how many days later (or earlier) the NDVI peak occurred compared to the GCVI peak. 

- CHALLENGE: include the `PlantingDate` column in `site_data`. Use `as_date` with the argument `format = format = "%m/%d/%Y"` to convert the planting date to a `date` data type. Determine how many days after the planting the peak NDVI occurred. 



---

## Homework
- Assignment 2 due Tuesday 2/14
- Read Unit 1 Module 4, Part 3
- Read tidy data [overview](https://cran.r-project.org/web/packages/tidyr/vignettes/tidy-data.html). Link to full paper [here](https://vita.had.co.nz/papers/tidy-data.pdf).
- Read [tibbles overview](https://cran.r-project.org/web/packages/tibble/vignettes/tibble.html)

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
